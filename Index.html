<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SoundOps Pro | ÙƒØ§Ø´Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</title>
  <meta name="description" content="ØªØ­Ù„ÙŠÙ„ ØµÙˆØªÙŠ ÙˆØ§ÙƒØªØ´Ø§Ù Ø¹ØªØ§Ø¯ (Hardware Detection)">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* Theme: Cyber-Security / Professional Dark Mode */
    :root {
      --bg-dark: #0f111a;
      --bg-panel: #1a1d2d;
      --primary: #3b82f6;
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.08);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg-dark);
      background-image: 
        linear-gradient(rgba(15, 17, 26, 0.9), rgba(15, 17, 26, 0.9)),
        repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(59, 130, 246, 0.03) 1px, rgba(59, 130, 246, 0.03) 2px);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .app-container { width: 100%; max-width: 1000px; animation: fadeIn 0.6s ease-out; }

    header {
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .brand { font-weight: 900; font-size: 1.5rem; letter-spacing: -0.5px; color: #fff; }
    .brand span { color: var(--primary); }
    
    .status-badge { 
      background: rgba(59, 130, 246, 0.1); color: var(--primary); 
      padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;
      border: 1px solid rgba(59, 130, 246, 0.2); font-family: monospace;
    }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }

    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
    }
    
    h2 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--text-muted); font-weight: 500; }

    /* Hardware Monitor Styles */
    .hw-monitor {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .hw-icon {
      width: 40px; height: 40px; 
      border-radius: 50%;
      background: var(--bg-panel);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
      border: 2px solid var(--text-muted);
      color: var(--text-muted);
      transition: 0.3s;
    }
    .hw-icon.active-external { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
    .hw-icon.active-internal { border-color: var(--warning); color: var(--warning); }
    
    .hw-details { flex: 1; }
    .hw-status-text { font-weight: 700; font-size: 0.95rem; display: block; }
    .hw-name { font-size: 0.8rem; color: var(--text-muted); font-family: monospace; margin-top: 4px; display: block; }

    /* Buttons */
    .btn-group { display: flex; gap: 10px; }
    button {
      flex: 1; padding: 12px; border: none; border-radius: 8px;
      font-weight: 700; cursor: pointer; transition: 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Progress & Metrics */
    .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .metric-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; text-align: center; }
    .metric-val { display: block; font-size: 1.5rem; font-weight: 900; color: #fff; }
    .metric-lbl { font-size: 0.8rem; color: var(--text-muted); }

    .score-circle { 
      width: 100px; height: 100px; border-radius: 50%; 
      background: conic-gradient(var(--text-muted) 0%, transparent 0%); 
      margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; position: relative;
    }
    .score-circle::before { content: ''; position: absolute; inset: 8px; background: var(--bg-panel); border-radius: 50%; }
    .score-text { position: relative; font-size: 2rem; font-weight: 900; z-index: 2; }
    
    .verdict { text-align: center; font-weight: bold; margin-bottom: 20px; }

    audio { width: 100%; margin-top: 15px; filter: invert(0.9) hue-rotate(180deg); }
    
    /* Loader */
    .loader-overlay {
      position: absolute; inset: 0; background: rgba(15, 17, 26, 0.95);
      display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 10;
    }
    .loader-overlay.active { display: flex; }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    footer { text-align: center; margin-top: 40px; color: var(--text-muted); font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="app-container">
  <header>
    <div class="brand">Sound<span>Ops</span> Pro</div>
    <div class="status-badge">V2.1 | Hardware Recon</div>
  </header>

  <!-- Hardware Monitor Section (New) -->
  <div class="card" style="border-color: var(--primary);">
    <h2>ğŸ“¡ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø© (Hardware Monitor)</h2>
    <div class="hw-monitor">
      <div id="hwIcon" class="hw-icon"><i class="icon">?</i></div>
      <div class="hw-details">
        <span id="hwStatus" class="hw-status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
        <span id="hwName" class="hw-name">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</span>
      </div>
      <button onclick="checkHardware(true)" style="width: auto; padding: 8px 15px; font-size: 0.8rem;" class="btn-ghost">ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">
      * Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ù†ÙŠØ©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…ØªØµÙØ­ ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø³Ù…Ø§Ø¹Ø© Ø¨Ø¯Ù‚Ø© 100% Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Anti-Fingerprinting Policy).
    </p>
  </div>

  <div class="grid" style="margin-top: 20px;">
    <!-- Recording Section -->
    <div class="card">
      <h2>1. Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØª</h2>
      <div class="btn-group">
        <button id="btnRecStart" class="btn-danger">â— Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button id="btnRecStop" class="btn-ghost" disabled>â–  Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
      <div id="recTimer" style="text-align:center; margin-top:15px; color:var(--danger); font-family:monospace; visibility:hidden">00:00</div>
    </div>

    <!-- Analysis Section -->
    <div class="card">
      <h2>2. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</h2>
      <div class="loader-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="margin-top:10px; color:var(--primary)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
      </div>
      
      <button id="btnAnalyze" class="btn-primary" disabled>âš¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</button>
      <audio id="audioPlayer" controls></audio>
    </div>
  </div>

  <!-- Results Section -->
  <div class="card" id="resultsPanel" style="display: none;">
    <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</h2>
    <div class="score-circle" id="scoreCircle">
      <div class="score-text" id="scoreVal">0</div>
    </div>
    <div class="verdict" id="verdictText">--</div>
    
    <div class="metric-grid">
      <div class="metric-item">
        <span class="metric-val" id="valSNR">--</span>
        <span class="metric-lbl">SNR (Noise)</span>
      </div>
      <div class="metric-item">
        <span class="metric-val" id="valVAD">--</span>
        <span class="metric-lbl">Ù†Ø´Ø§Ø· Ø§Ù„ØµÙˆØª</span>
      </div>
    </div>

    <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
      <h3 style="font-size: 1rem;">Ø§Ù„ØªÙˆØµÙŠØ§Øª:</h3>
      <ul id="recommendations" style="font-size: 0.9rem; color: var(--text-muted); padding-right: 20px;"></ul>
    </div>
  </div>

  <footer>
    Developed by <strong>Mahmoud Ibrahim</strong> | Cyber-Sec Student <br>
    Hardware Enumeration & Signal Processing Module
  </footer>
</div>

<script>
// --- Hardware Detection Logic (The New Part) ---
const hwIcon = document.getElementById('hwIcon');
const hwStatus = document.getElementById('hwStatus');
const hwName = document.getElementById('hwName');

async function checkHardware(requestPermission = false) {
  try {
    // If requestPermission is true, we briefly open a stream to unlock labels
    if (requestPermission) {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      // Stop immediately, we just wanted the permission/labels
      stream.getTracks().forEach(t => t.stop());
    }

    const devices = await navigator.mediaDevices.enumerateDevices();
    const audioInputs = devices.filter(device => device.kind === 'audioinput');
    
    // Default State
    let type = 'internal';
    let label = 'Unknown Device';
    let isExternal = false;

    // Smart Detection Logic
    if (audioInputs.length > 0) {
      // Typically the last plugged device becomes the default, or we scan all
      const activeDevice = audioInputs.find(d => d.deviceId === 'default') || audioInputs[0];
      label = activeDevice.label || 'Microphone (Hidden Name)';
      
      // Heuristics for detection
      const lowerLabel = label.toLowerCase();
      if (
        lowerLabel.includes('headset') || 
        lowerLabel.includes('bluetooth') || 
        lowerLabel.includes('usb') || 
        lowerLabel.includes('external') ||
        lowerLabel.includes('wired') ||
        audioInputs.length > 2 // Usually phone has 1 or 2 mics, if >2 likely external plugged
      ) {
        type = 'external';
        isExternal = true;
      }
    }

    updateHWUI(isExternal, label, audioInputs.length);

  } catch (err) {
    console.error(err);
    hwStatus.textContent = "ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
    hwName.textContent = "ØªÙ… Ø­Ø¸Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²";
    hwIcon.style.color = 'var(--danger)';
    hwIcon.style.borderColor = 'var(--danger)';
    hwIcon.innerHTML = '!';
  }
}

function updateHWUI(isExternal, label, count) {
  if (label === 'Microphone (Hidden Name)') {
    hwStatus.textContent = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ (ÙŠØ¬Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹)";
    hwName.textContent = "Ø§Ø¶ØºØ· 'Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„' Ù„ÙƒØ´Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©";
    hwIcon.innerHTML = '?';
    hwIcon.className = 'hw-icon';
  } else if (isExternal) {
    hwStatus.textContent = "Ù…Ø§ÙŠÙƒ Ø®Ø§Ø±Ø¬ÙŠ Ù…ØªØµÙ„ (External)";
    hwName.textContent = `Device: ${label}`;
    hwIcon.innerHTML = 'ğŸ§';
    hwIcon.className = 'hw-icon active-external';
  } else {
    hwStatus.textContent = "Ù…Ø§ÙŠÙƒ Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Internal)";
    hwName.textContent = `Device: ${label}`;
    hwIcon.innerHTML = 'ğŸ“±';
    hwIcon.className = 'hw-icon active-internal';
  }
}

// Listen for plugging/unplugging
navigator.mediaDevices.ondevicechange = () => {
  checkHardware(false);
};

// Initial check (might be limited until permission)
checkHardware(false);


// --- Recording & Analysis Logic (Existing Core) ---
let mediaRecorder;
let recordedChunks = [];
let audioContext;
let currentBuffer;

const btnRecStart = document.getElementById('btnRecStart');
const btnRecStop = document.getElementById('btnRecStop');
const btnAnalyze = document.getElementById('btnAnalyze');
const player = document.getElementById('audioPlayer');
const resultsPanel = document.getElementById('resultsPanel');
const loadingOverlay = document.getElementById('loadingOverlay');

btnRecStart.addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    // Update Hardware Info now that we have permission
    checkHardware(false);

    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];
    
    mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
    
    mediaRecorder.onstop = async () => {
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      player.src = url;
      
      // Load for analysis
      const arrayBuffer = await blob.arrayBuffer();
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      currentBuffer = await audioContext.decodeAudioData(arrayBuffer);
      
      btnAnalyze.disabled = false;
      stream.getTracks().forEach(track => track.stop());
      document.getElementById('recTimer').style.visibility = 'hidden';
    };

    mediaRecorder.start();
    btnRecStart.disabled = true;
    btnRecStop.disabled = false;
    
    // Simple Timer
    let start = Date.now();
    document.getElementById('recTimer').style.visibility = 'visible';
    let timerInt = setInterval(() => {
      if(mediaRecorder.state === 'inactive') clearInterval(timerInt);
      let diff = Math.floor((Date.now() - start)/1000);
      document.getElementById('recTimer').innerText = `Recording: ${diff}s`;
    }, 1000);

  } catch (err) {
    alert("Error: " + err.message);
  }
});

btnRecStop.addEventListener('click', () => {
  if(mediaRecorder) mediaRecorder.stop();
  btnRecStart.disabled = false;
  btnRecStop.disabled = true;
});

btnAnalyze.addEventListener('click', () => {
  if(!currentBuffer) return;
  loadingOverlay.classList.add('active');
  
  setTimeout(() => {
    const metrics = analyzeAudio(currentBuffer);
    renderResults(metrics);
    loadingOverlay.classList.remove('active');
  }, 500); // Simulate processing delay for UX
});

function analyzeAudio(buffer) {
  // Simplified Analysis Logic for Demo
  const raw = buffer.getChannelData(0);
  let sum = 0;
  let clipCount = 0;
  
  // Calculate RMS and Clips
  for(let i=0; i<raw.length; i+=100) { // skip samples for speed
    const val = raw[i];
    sum += val*val;
    if(Math.abs(val) > 0.95) clipCount++;
  }
  const rms = Math.sqrt(sum / (raw.length/100));
  const snr = Math.abs(20 * Math.log10(rms / 0.0001)); // Rough estimate
  
  // Scoring
  let score = Math.min(100, Math.round(snr * 1.8));
  if(clipCount > 10) score -= 20; // Penalize clipping
  
  return { score, snr, vad: 0.65 }; // Mock VAD for now
}

function renderResults(m) {
  resultsPanel.style.display = 'block';
  document.getElementById('scoreVal').innerText = m.score;
  document.getElementById('valSNR').innerText = m.snr.toFixed(1) + ' dB';
  document.getElementById('valVAD').innerText = 'Good';
  
  const circle = document.getElementById('scoreCircle');
  let color = m.score > 70 ? 'var(--accent)' : 'var(--warning)';
  circle.style.background = `conic-gradient(${color} ${m.score}%, transparent 0%)`;
  
  const recs = document.getElementById('recommendations');
  recs.innerHTML = '';
  if(m.score > 80) recs.innerHTML += '<li>ØµÙˆØª Ù†Ù‚ÙŠ Ø¬Ø¯Ø§Ù‹ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª.</li>';
  else recs.innerHTML += '<li>Ø¬ÙˆØ¯Ø© Ù…ØªÙˆØ³Ø·Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‚Ù„ÙŠÙ„ Ø¶ÙˆØ¶Ø§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ©.</li>';
  
  // Hardware-aware recommendation
  const hwText = hwStatus.innerText;
  if(hwText.includes('Internal')) {
    recs.innerHTML += '<li style="color:var(--warning)">âš ï¸ Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ù…Ø§ÙŠÙƒ Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ. Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø© ("Mahmoud Quality")ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø³Ù…Ø§Ø¹Ø© Ø®Ø§Ø±Ø¬ÙŠØ©.</li>';
  }
}
</script>
</body>
</html>

