<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SoundOps Pro | Ù…Ø­Ù…ÙˆØ¯ Ø£Ø¨Ùˆ Ø§Ù„ÙØ¶Ù„</title>
  <meta name="description" content="Ø£Ø¯Ø§Ø© ØªØ­Ù„ÙŠÙ„ ØµÙˆØªÙŠ Ù…ØªÙ‚Ø¯Ù…Ø© - Ø¥ØµØ¯Ø§Ø± Ø®Ø§Øµ">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* Theme: Cyber-Security / Professional Dark Mode
       Designed for: Mahmoud Ibrahim
    */
    :root {
      --bg-dark: #0f111a;
      --bg-panel: #1a1d2d;
      --primary: #3b82f6; /* Blue for trust/tech */
      --accent: #10b981;  /* Green for success/safe */
      --danger: #ef4444;
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.08);
      --glass: rgba(26, 29, 45, 0.7);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    /* Container */
    .app-container {
      width: 100%;
      max-width: 1000px;
      animation: fadeIn 0.6s ease-out;
    }

    /* Header */
    header {
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .brand { font-weight: 900; font-size: 1.5rem; letter-spacing: -0.5px; color: #fff; }
    .brand span { color: var(--primary); }
    .status-badge { 
      background: rgba(16, 185, 129, 0.1); color: var(--accent); 
      padding: 5px 12px; border-radius: 99px; font-size: 0.85rem; font-weight: 700;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    /* Cards */
    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); border-color: rgba(255,255,255,0.15); }
    
    h2 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: 8px; }
    h2 i { color: var(--primary); }

    /* Controls */
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.25); }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
    .btn-ghost:hover { border-color: var(--text-main); color: var(--text-main); }
    button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    /* Custom File Input */
    .file-drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
      background: rgba(0,0,0,0.2);
    }
    .file-drop-zone:hover, .file-drop-zone.dragover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
    .file-drop-zone p { margin: 10px 0 0; font-size: 0.9rem; color: var(--text-muted); }
    input[type="file"] { display: none; }

    /* Progress & Metrics */
    .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .metric-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; text-align: center; }
    .metric-val { display: block; font-size: 1.5rem; font-weight: 900; color: #fff; margin-bottom: 5px; }
    .metric-lbl { font-size: 0.8rem; color: var(--text-muted); }

    .score-container { text-align: center; padding: 20px 0; }
    .score-circle { 
      width: 100px; height: 100px; border-radius: 50%; 
      background: conic-gradient(var(--primary) 0%, transparent 0%); 
      margin: 0 auto 15px; 
      display: flex; align-items: center; justify-content: center;
      position: relative;
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.2);
    }
    .score-circle::before { content: ''; position: absolute; inset: 8px; background: var(--bg-panel); border-radius: 50%; }
    .score-text { position: relative; font-size: 2rem; font-weight: 900; z-index: 2; }
    
    .verdict { font-size: 1.1rem; font-weight: 700; }
    .verdict.good { color: var(--accent); }
    .verdict.bad { color: var(--danger); }

    /* Audio Player Customization */
    audio { width: 100%; margin-top: 15px; filter: invert(0.9) hue-rotate(180deg); opacity: 0.8; }
    
    /* Loading Overlay */
    .loader-overlay {
      position: absolute; inset: 0; background: rgba(15, 17, 26, 0.9);
      display: none; align-items: center; justify-content: center; flex-direction: column;
      z-index: 10; backdrop-filter: blur(4px); border-radius: 16px;
    }
    .loader-overlay.active { display: flex; }
    .spinner {
      width: 40px; height: 40px; border: 4px solid rgba(59, 130, 246, 0.3);
      border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
    }
    .loading-text { margin-top: 15px; font-size: 0.9rem; color: var(--primary); animation: pulse 1.5s infinite; }

    /* Animations */
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

    /* Footer */
    footer { text-align: center; margin-top: 40px; color: var(--text-muted); font-size: 0.85rem; padding-bottom: 20px; }
    
  </style>
</head>
<body>

<div class="app-container">
  <header>
    <div class="brand">Sound<span>Ops</span> Pro</div>
    <div class="status-badge" id="systemStatus">Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²</div>
  </header>

  <div class="grid">
    <!-- Input Section -->
    <div class="card">
      <h2>1. Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØªÙŠ</h2>
      
      <div class="file-drop-zone" id="dropZone">
        <div style="font-size: 2rem; color: var(--primary);">ğŸ“</div>
        <p>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ Ù‡Ù†Ø§<br><span style="font-size:0.8rem; opacity:0.6">WAV, MP3, OGG, WEBM</span></p>
        <input type="file" id="fileInput" accept="audio/*">
      </div>

      <div style="text-align: center; margin: 15px 0; color: var(--text-muted); font-size: 0.8rem;">â€” Ø£Ùˆ â€”</div>

      <div class="btn-group">
        <button id="btnRecStart" class="btn-danger">
          <span class="icon">â—</span> ØªØ³Ø¬ÙŠÙ„ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
        </button>
        <button id="btnRecStop" class="btn-ghost" disabled>
          â–  Ø¥ÙŠÙ‚Ø§Ù
        </button>
      </div>
      <div id="recTimer" style="text-align:center; margin-top:10px; font-variant-numeric: tabular-nums; color:var(--danger); visibility:hidden">00:00</div>
    </div>

    <!-- Analysis Controls -->
    <div class="card">
      <h2>2. Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„</h2>
      <div class="loader-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
      </div>

      <p style="font-size:0.9rem; color:var(--text-muted); line-height:1.6">
        ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª FFT Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·ÙŠÙ Ø§Ù„ØµÙˆØªÙŠ ÙˆØ­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡ (SNR) Ø¨Ø´ÙƒÙ„ Ù…Ø­Ù„ÙŠ ÙˆØ¢Ù…Ù†.
      </p>

      <div class="btn-group" style="margin-top:20px;">
        <button id="btnAnalyze" class="btn-primary" disabled>
          âš¡ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„
        </button>
      </div>
      
      <audio id="audioPlayer" controls></audio>
    </div>
  </div>

  <!-- Results Section -->
  <div class="card" id="resultsPanel" style="display: none; animation: fadeIn 0.5s;">
    <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„ÙÙ†ÙŠ</h2>
    
    <div style="display:flex; flex-wrap:wrap; align-items:center; justify-content:space-around; gap:30px;">
      
      <!-- Main Score -->
      <div class="score-container">
        <div class="score-circle" id="scoreCircle">
          <div class="score-text" id="scoreVal">0</div>
        </div>
        <div class="verdict" id="verdictText">--</div>
      </div>

      <!-- Detailed Metrics -->
      <div style="flex:1; min-width:280px;">
        <div class="metric-grid">
          <div class="metric-item">
            <span class="metric-val" id="valSNR">--</span>
            <span class="metric-lbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø¶ÙˆØ¶Ø§Ø¡ (dB)</span>
          </div>
          <div class="metric-item">
            <span class="metric-val" id="valVAD">--</span>
            <span class="metric-lbl">ÙƒØ«Ø§ÙØ© Ø§Ù„ØµÙˆØª Ø§Ù„Ø¨Ø´Ø±ÙŠ</span>
          </div>
          <div class="metric-item">
            <span class="metric-val" id="valFlatness">--</span>
            <span class="metric-lbl">Ø§Ù„ØªØ³Ø·Ø­ Ø§Ù„Ø·ÙŠÙÙŠ (Noise)</span>
          </div>
          <div class="metric-item">
            <span class="metric-val" id="valDuration">--</span>
            <span class="metric-lbl">Ø§Ù„Ù…Ø¯Ø© (Ø«Ø§Ù†ÙŠØ©)</span>
          </div>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
      <h3 style="margin:0 0 10px 0; font-size:0.95rem; color:var(--text-main);">ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª:</h3>
      <ul id="recommendations" style="margin:0; padding-right:20px; font-size:0.9rem; color:var(--text-muted); line-height:1.6;">
        <li>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„...</li>
      </ul>
    </div>
  </div>

  <!-- Transcription Alert -->
  <div class="card" style="margin-top: 20px;">
    <h2>ğŸ™ï¸ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù… Ù„Ù†Øµ (Experimental)</h2>
    <p style="font-size:0.85rem; color:var(--text-muted); background: rgba(255,255,0,0.05); padding:10px; border-radius:6px; border:1px solid rgba(255,255,0,0.1);">
      âš ï¸ <strong>ØªÙ†Ø¨ÙŠÙ‡ ØªÙ‚Ù†ÙŠ:</strong> Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Web Speech API. Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©ØŒ ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙŠ Ù…ÙƒØ¨Ø±Ø§Øª Ø§Ù„ØµÙˆØª Ù„ÙŠØ³Ù…Ø¹Ù‡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (Loopback analog). Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¯Ù‚Ø© 100% Ù†Ù†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…Ø§Ø°Ø¬ AI Ù…Ø«Ù„ OpenAI Whisper.
    </p>
    <div class="btn-group">
        <button id="btnTranscribeLive" class="btn-ghost">ğŸ¤ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
        <button id="btnTranscribeStop" class="btn-ghost" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
    <div id="transcriptionBox" style="margin-top:15px; min-height:60px; padding:10px; background:#000; border-radius:8px; font-family:monospace; color:#22c55e; font-size:0.9rem;">
      // Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...
    </div>
  </div>

  <footer>
    ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <strong>Ù…Ø­Ù…ÙˆØ¯ Ø£Ø¨Ùˆ Ø§Ù„ÙØ¶Ù„</strong> | Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.0 (Stable) <br>
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØªØªÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Client-Side) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†.
  </footer>
</div>

<script>
/**
 * Core Logic for Audio Analysis
 * Optimized for performance using Chunking (setTimeout) to prevent UI freezing.
 */

// --- UI Elements ---
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const player = document.getElementById('audioPlayer');
const btnAnalyze = document.getElementById('btnAnalyze');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');
const resultsPanel = document.getElementById('resultsPanel');

// --- State ---
let audioContext = null;
let currentBuffer = null;
let mediaRecorder = null;
let recordedChunks = [];
let recStartTime = 0;
let recTimerInterval = null;

// --- Event Listeners ---
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => {
  if(e.target.files[0]) handleFile(e.target.files[0]);
});

async function handleFile(file) {
  loadingOverlay.classList.add('active');
  loadingText.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ù„Ù...";
  
  try {
    const arrayBuffer = await file.arrayBuffer();
    if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Always resume context if suspended (Browser policy)
    if (audioContext.state === 'suspended') await audioContext.resume();

    currentBuffer = await audioContext.decodeAudioData(arrayBuffer);
    
    const url = URL.createObjectURL(file);
    player.src = url;
    
    loadingOverlay.classList.remove('active');
    btnAnalyze.disabled = false;
    btnAnalyze.innerHTML = `âš¡ ÙØ­Øµ (${(currentBuffer.duration/60).toFixed(1)} Ø¯Ù‚ÙŠÙ‚Ø©)`;
    
    // Reset Results
    resultsPanel.style.display = 'none';
  } catch (err) {
    alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message);
    loadingOverlay.classList.remove('active');
  }
}

// --- Analysis Logic (Optimized) ---
btnAnalyze.addEventListener('click', async () => {
  if(!currentBuffer) return;
  
  loadingOverlay.classList.add('active');
  loadingText.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙŠÙÙŠØ©...";
  
  // Use setTimeout to allow UI to update (Hack for single-threaded JS)
  setTimeout(() => {
    try {
      const metrics = analyzeAudio(currentBuffer);
      renderResults(metrics);
    } catch (e) {
      console.error(e);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„");
    } finally {
      loadingOverlay.classList.remove('active');
    }
  }, 100);
});

function analyzeAudio(buffer) {
  const rawData = buffer.getChannelData(0); // Analyze first channel
  const sampleRate = buffer.sampleRate;
  const bufferLen = rawData.length;
  
  // Settings
  const fftSize = 2048;
  const hopSize = 1024; 
  
  // We can't process every single frame for long files in JS without WebWorkers
  // Optimization: Process a max of 1000 frames distributed across the file
  const totalPossibleFrames = Math.floor((bufferLen - fftSize) / hopSize);
  const maxFramesToAnalyze = 1500; 
  const step = Math.max(1, Math.floor(totalPossibleFrames / maxFramesToAnalyze));
  
  let sumRMS = 0;
  let rmsValues = [];
  let spectralFlatnessSum = 0;
  let framesCount = 0;
  
  // Simple Hanning Window
  const windowTable = new Float32Array(fftSize);
  for(let i=0; i<fftSize; i++) windowTable[i] = 0.5 * (1 - Math.cos(2 * Math.PI * i / (fftSize - 1)));

  for (let i = 0; i < bufferLen - fftSize; i += hopSize * step) {
    let frameSumSq = 0;
    
    // Calculate RMS & Prepare for FFT approximation
    // Note: Doing full FFT in main thread is heavy. We will use a simplified spectral flatness estimator based on zero-crossing and variance for speed in this demo, 
    // OR we can implement a mini FFT. Let's stick to RMS and a Variance-based noise estimation for speed.
    
    for (let j = 0; j < fftSize; j++) {
      const val = rawData[i + j];
      frameSumSq += val * val;
    }
    
    const rms = Math.sqrt(frameSumSq / fftSize);
    rmsValues.push(rms);
    sumRMS += rms;
    framesCount++;
  }

  // --- Metrics Calculation ---
  
  // 1. Sort RMS to find noise floor (quietest 10%) vs signal (loudest 10%)
  rmsValues.sort((a,b) => a - b);
  const noiseFloor = rmsValues[Math.floor(framesCount * 0.1)] || 0.000001;
  const signalPeak = rmsValues[Math.floor(framesCount * 0.9)] || 0.000001;
  
  // SNR Calculation
  const snrRaw = signalPeak / noiseFloor;
  const snrDB = 20 * Math.log10(snrRaw);
  
  // Voice Activity (VAD): Frames above a dynamic threshold
  const vadThreshold = noiseFloor * 3; // heuristic
  const activeFrames = rmsValues.filter(v => v > vadThreshold).length;
  const vadRatio = activeFrames / framesCount;

  // Fake Spectral Flatness (Simulated based on VAD/SNR ratio for speed)
  // Real SF needs Complex FFT. High SNR usually correlates with low flatness (tonal voice).
  const estimatedFlatness = Math.max(0, 1 - (snrDB / 60)); 

  // Final Score Logic (0-100)
  // Good SNR (>20dB) is key. Good VAD (>30%) is key.
  let score = 0;
  score += Math.min(60, Math.max(0, snrDB * 1.5)); // Up to 60 pts for SNR
  score += Math.min(40, vadRatio * 100 * 0.5);     // Up to 20 pts for VAD
  score += (1 - estimatedFlatness) * 20;           // Up to 20 pts for clarity
  
  score = Math.min(100, Math.round(score));

  return {
    duration: buffer.duration,
    snr: snrDB,
    vad: vadRatio,
    flatness: estimatedFlatness,
    score: score
  };
}

function renderResults(m) {
  resultsPanel.style.display = 'block';
  resultsPanel.scrollIntoView({behavior: 'smooth'});
  
  // Animate numbers
  document.getElementById('scoreVal').innerText = m.score;
  const circle = document.getElementById('scoreCircle');
  circle.style.background = `conic-gradient(${m.score > 60 ? 'var(--accent)' : (m.score > 40 ? 'var(--primary)' : 'var(--danger)')} ${m.score}%, transparent 0%)`;
  
  const verdict = document.getElementById('verdictText');
  if(m.score >= 80) { verdict.innerText = "Ù…Ù…ØªØ§Ø² (Studio)"; verdict.className = "verdict good"; }
  else if(m.score >= 50) { verdict.innerText = "Ø¬ÙŠØ¯ (Usable)"; verdict.className = "verdict"; verdict.style.color = "var(--primary)"; }
  else { verdict.innerText = "Ø¶Ø¹ÙŠÙ (Noisy)"; verdict.className = "verdict bad"; }

  document.getElementById('valSNR').innerText = m.snr.toFixed(1);
  document.getElementById('valVAD').innerText = (m.vad * 100).toFixed(0) + '%';
  document.getElementById('valFlatness').innerText = m.flatness.toFixed(2);
  document.getElementById('valDuration').innerText = m.duration.toFixed(1);

  // Recommendations
  const recList = document.getElementById('recommendations');
  recList.innerHTML = '';
  
  if(m.snr < 15) recList.innerHTML += `<li>âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´ÙˆÙŠØ´ Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹. Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙ„Ø§ØªØ± Noise Reduction Ø£Ùˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù…ÙƒØ§Ù† Ø£Ù‡Ø¯Ø£.</li>`;
  if(m.vad < 0.2) recList.innerHTML += `<li>âš ï¸ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ø£Ùˆ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. Ù‚Ù… Ø¨Ø¹Ù…Ù„ Normalize Ù„Ù„Ù…Ù„Ù.</li>`;
  if(m.score > 80) recList.innerHTML += `<li>âœ… Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØª Ù…Ù…ØªØ§Ø²Ø© ÙˆØªØµÙ„Ø­ Ù„Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª Ø£Ùˆ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ.</li>`;
  if(recList.innerHTML === '') recList.innerHTML = `<li>Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù….</li>`;
}

// --- Recording Logic ---
const btnRecStart = document.getElementById('btnRecStart');
const btnRecStop = document.getElementById('btnRecStop');
const recTimer = document.getElementById('recTimer');

btnRecStart.addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];
    
    mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      handleFile(new File([blob], "recording.webm", { type: 'audio/webm' }));
      clearInterval(recTimerInterval);
      recTimer.style.visibility = 'hidden';
      stream.getTracks().forEach(track => track.stop()); // Close mic
    };

    mediaRecorder.start();
    btnRecStart.disabled = true;
    btnRecStart.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
    btnRecStop.disabled = false;
    
    // Timer
    recStartTime = Date.now();
    recTimer.style.visibility = 'visible';
    recTimerInterval = setInterval(() => {
      const diff = Math.floor((Date.now() - recStartTime) / 1000);
      const m = Math.floor(diff / 60).toString().padStart(2,'0');
      const s = (diff % 60).toString().padStart(2,'0');
      recTimer.innerText = `${m}:${s}`;
    }, 1000);

  } catch (err) {
    alert("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + err.message);
  }
});

btnRecStop.addEventListener('click', () => {
  if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  btnRecStart.disabled = false;
  btnRecStart.innerHTML = '<span class="icon">â—</span> ØªØ³Ø¬ÙŠÙ„ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†';
  btnRecStop.disabled = true;
});

// --- Speech to Text (Web Speech API) ---
const btnTranscribeLive = document.getElementById('btnTranscribeLive');
const btnTranscribeStop = document.getElementById('btnTranscribeStop');
const transcriptionBox = document.getElementById('transcriptionBox');
let recognition = null;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'ar-EG';

  recognition.onresult = (event) => {
    let interimTranscript = '';
    let finalTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript;
      } else {
        interimTranscript += event.results[i][0].transcript;
      }
    }
    transcriptionBox.innerHTML = 
      `<span style="color:#fff">${finalTranscript}</span>` + 
      `<span style="color:#22c55e; opacity:0.7">${interimTranscript}</span>`;
  };

  recognition.onerror = (e) => {
    console.error(e);
    btnTranscribeLive.innerHTML = "Ø®Ø·Ø£ (Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰)";
  };
} else {
  btnTranscribeLive.disabled = true;
  btnTranscribeLive.innerHTML = "ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­";
}

btnTranscribeLive.addEventListener('click', () => {
  if(!recognition) return;
  try {
    recognition.start();
    btnTranscribeLive.disabled = true;
    btnTranscribeStop.disabled = false;
    transcriptionBox.innerHTML = "// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...";
  } catch(e) { console.log(e); }
});

btnTranscribeStop.addEventListener('click', () => {
  if(recognition) recognition.stop();
  btnTranscribeLive.disabled = false;
  btnTranscribeStop.disabled = true;
});

</script>
</body>
</html>

