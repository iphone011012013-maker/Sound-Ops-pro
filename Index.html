<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة الفحص الأمني الصوتي | Arabic Security Tool</title>
    
    <!-- مكتبة التنسيق -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- مكتبة الأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- الخطوط العربية -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #050505;
            color: #e0e0e0;
            background-image: linear-gradient(45deg, #0a0a0a 25%, transparent 25%, transparent 75%, #0a0a0a 75%, #0a0a0a), 
                              linear-gradient(45deg, #0a0a0a 25%, transparent 25%, transparent 75%, #0a0a0a 75%, #0a0a0a);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        /* حدود مضيئة */
        .neon-border {
            border: 1px solid #333;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        .neon-border:hover {
            border-color: #555;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.1);
        }

        /* شارات الحالة */
        .badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .badge-danger { background: rgba(220, 38, 38, 0.1); border: 1px solid #dc2626; color: #ef4444; }
        .badge-safe { background: rgba(22, 163, 74, 0.1); border: 1px solid #16a34a; color: #4ade80; }
        .badge-warn { background: rgba(202, 138, 4, 0.1); border: 1px solid #ca8a04; color: #facc15; }
        .badge-info { background: rgba(37, 99, 235, 0.1); border: 1px solid #2563eb; color: #60a5fa; }

        /* تأثير النبض للمايك */
        .recording-pulse {
            width: 12px; height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* تخصيص شريط التمرير */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- الحاوية الرئيسية -->
    <div class="w-full max-w-4xl bg-black/90 backdrop-blur border border-gray-800 rounded-xl shadow-2xl overflow-hidden relative">
        
        <!-- الشريط العلوي -->
        <div class="bg-gray-900/50 p-4 border-b border-gray-800 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-shield-halved text-red-600 text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold text-white">نظام كشف العتاد الصوتي</h1>
                    <p class="text-xs text-gray-500">أداة تحليل الأجهزة والخصوصية V4.0</p>
                </div>
            </div>
            <div id="sys-status" class="flex items-center gap-2 px-3 py-1 rounded bg-black border border-gray-800">
                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                <span class="text-xs text-gray-400">النظام في الانتظار</span>
            </div>
        </div>

        <!-- المحتوى -->
        <div class="p-6">

            <!-- شاشة البداية (طلب الإذن) -->
            <div id="start-screen" class="text-center py-12 space-y-6">
                <div class="w-20 h-20 mx-auto bg-gray-900 rounded-full flex items-center justify-center border border-gray-700">
                    <i class="fa-solid fa-user-shield text-4xl text-gray-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">مطلوب إذن الوصول</h2>
                <p class="text-gray-400 max-w-md mx-auto text-sm leading-relaxed">
                    لكي تتمكن الأداة من قراءة أسماء الأجهزة المتصلة (مثل اسم سماعة البلوتوث)، وتحديد ما إذا كانت خارجية أم لا، يجب السماح للمتصفح بالوصول للميكروفون.
                    <br><span class="text-red-500 text-xs mt-2 block">* لن يتم إرسال أي صوت لخارج جهازك، التحليل يتم محلياً.</span>
                </p>
                <button onclick="initializeSystem()" class="px-8 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-lg transition-all flex items-center gap-2 mx-auto">
                    <i class="fa-solid fa-power-off"></i> بدء الفحص وتشغيل النظام
                </button>
            </div>

            <!-- لوحة التحكم (مخفية) -->
            <div id="dashboard" class="hidden space-y-6">
                
                <!-- قسم تحليل الأجهزة -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- بطاقة الميكروفون -->
                    <div class="neon-border bg-gray-900/40 rounded-lg p-5 relative">
                        <div class="absolute top-4 left-4 text-gray-700 text-5xl opacity-20">
                            <i class="fa-solid fa-microphone-lines"></i>
                        </div>
                        <h3 class="text-sm text-gray-400 font-bold mb-4 border-b border-gray-800 pb-2">وحدة الإدخال (المايك)</h3>
                        
                        <div class="space-y-2">
                            <p class="text-xs text-gray-500">اسم الجهاز المتصل:</p>
                            <h2 id="mic-name" class="text-lg font-bold text-white break-words" dir="ltr">جاري الكشف...</h2>
                            <div id="mic-badges" class="flex gap-2 flex-wrap pt-2"></div>
                        </div>
                    </div>

                    <!-- بطاقة السماعات -->
                    <div class="neon-border bg-gray-900/40 rounded-lg p-5 relative">
                        <div class="absolute top-4 left-4 text-gray-700 text-5xl opacity-20">
                            <i class="fa-solid fa-headphones"></i>
                        </div>
                        <h3 class="text-sm text-gray-400 font-bold mb-4 border-b border-gray-800 pb-2">وحدة الإخراج (السماعة)</h3>
                        
                        <div class="space-y-2">
                            <p class="text-xs text-gray-500">اسم الجهاز المتصل:</p>
                            <h2 id="spk-name" class="text-lg font-bold text-white break-words" dir="ltr">جاري الكشف...</h2>
                            <div id="spk-badges" class="flex gap-2 flex-wrap pt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- شاشة الموجات الصوتية -->
                <div class="border border-gray-800 bg-black rounded-lg relative overflow-hidden h-40">
                    <p class="absolute top-2 right-3 text-[10px] text-green-500 font-mono z-10">مراقب الإشارة الحية</p>
                    <canvas id="visualizer" class="w-full h-full opacity-90"></canvas>
                </div>

                <!-- أزرار الاختبار -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- زر السماعات -->
                    <button onclick="testSpeakerTone()" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-4 rounded-lg transition-all group">
                        <i class="fa-solid fa-volume-high text-2xl text-blue-500 mb-2 group-hover:scale-110 transition-transform"></i>
                        <div class="font-bold text-sm">اختبار السماعات</div>
                        <div class="text-[10px] text-gray-400">إصدار نغمة تجريبية</div>
                    </button>
                    
                    <!-- زر المايك -->
                    <button id="mic-test-btn" onclick="testMicLoopback()" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white p-4 rounded-lg transition-all group relative overflow-hidden">
                        <div class="flex flex-col items-center z-10 relative">
                            <div id="mic-icon-wrapper">
                                <i class="fa-solid fa-microphone text-2xl text-red-500 mb-2 group-hover:scale-110 transition-transform"></i>
                            </div>
                            <div id="mic-btn-text" class="font-bold text-sm">اختبار الميكروفون</div>
                            <div id="mic-sub-text" class="text-[10px] text-gray-400">تسجيل وإعادة الاستماع</div>
                        </div>
                    </button>
                </div>

                <!-- سجل الأحداث -->
                <div class="bg-black rounded-lg border border-gray-800 p-3 h-32 flex flex-col">
                    <div class="text-[11px] text-gray-500 border-b border-gray-900 pb-1 mb-2 font-mono">سجل النظام الأمني :: SYSTEM LOGS</div>
                    <div id="logs" class="flex-1 overflow-y-auto space-y-1 text-xs font-mono px-1"></div>
                </div>

            </div>

            <!-- التذييل -->
            <div class="mt-6 pt-4 border-t border-gray-900 text-center">
                <p class="text-[10px] text-gray-600">برمجة وتطوير: محمود إبراهيم | قسم الأمن السيبراني</p>
            </div>

        </div>
    </div>

    <script>
        // المتغيرات العامة للنظام
        let audioCtx, analyser, dataArray, canvas, canvasCtx;
        let stream;
        let mediaRecorder, chunks = [];

        // دالة الكتابة في السجل (بالعربية)
        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const el = document.createElement('div');
            const time = new Date().toLocaleTimeString('ar-EG');
            
            let color = 'text-gray-400';
            let icon = '<i class="fa-solid fa-info-circle ml-1"></i>';

            if(type === 'alert') { color = 'text-red-500'; icon = '<i class="fa-solid fa-triangle-exclamation ml-1"></i>'; }
            if(type === 'success') { color = 'text-green-500'; icon = '<i class="fa-solid fa-check-circle ml-1"></i>'; }
            if(type === 'warn') { color = 'text-yellow-500'; icon = '<i class="fa-solid fa-bolt ml-1"></i>'; }

            el.className = `${color} hover:bg-gray-900 p-1 rounded transition flex items-center`;
            el.innerHTML = `<span class="opacity-50 ml-2 text-[10px]">[${time}]</span> ${icon} ${msg}`;
            logs.prepend(el);
        }

        // 1. بدء تشغيل النظام
        async function initializeSystem() {
            try {
                // إنشاء سياق الصوت
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // طلب صلاحية المايك
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // الانتقال للواجهة الرئيسية
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // تحديث حالة النظام
                const statusBadge = document.getElementById('sys-status');
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span><span class="text-xs text-green-500 font-bold">النظام يعمل</span>`;
                statusBadge.className = "flex items-center gap-2 px-3 py-1 rounded bg-black border border-green-900";

                log('تم تشغيل النظام بنجاح.', 'success');
                log('تم منح صلاحيات الوصول للعتاد.', 'success');

                // تشغيل المراقب البياني
                setupVisualizer();
                
                // فحص الأجهزة المتصلة
                detectHardware();

                // مراقبة أي تغيير (فصل أو توصيل سماعة)
                navigator.mediaDevices.ondevicechange = () => {
                    log('تنبيه: تم اكتشاف تغيير في الأجهزة المتصلة!', 'alert');
                    detectHardware();
                };

            } catch (err) {
                console.error(err);
                log('فشل الوصول: تأكد من السماح باستخدام الميكروفون.', 'alert');
                alert("عذراً، يجب السماح باستخدام الميكروفون لكي يعمل البرنامج وتظهر أسماء الأجهزة.");
            }
        }

        // 2. تحليل الأجهزة وكشف نوعها
        async function detectHardware() {
            // جلب قائمة الأجهزة
            const devices = await navigator.mediaDevices.enumerateDevices();
            
            // الكلمات الدلالية للأجهزة الخارجية
            const bluetoothKeywords = ['bluetooth', 'wireless', 'airpods', 'buds', 'freebuds', 'jbl', 'sony', 'bose', 'لاسلكي'];
            const usbKeywords = ['usb', 'يو اس بي'];
            const externalKeywords = ['headset', 'headphone', 'external', 'mic', 'سماعة', 'خارجي'];

            // البحث عن أجهزة الصوت
            const mic = devices.find(d => d.kind === 'audioinput' && d.deviceId !== 'default') || devices.find(d => d.kind === 'audioinput');
            const spk = devices.find(d => d.kind === 'audiooutput' && d.deviceId !== 'default') || devices.find(d => d.kind === 'audiooutput');

            // دالة مساعدة لإنشاء الشارات (Badges) بالعربية
            function createBadges(label) {
                label = label.toLowerCase();
                let badges = '';
                let isSuspicious = false;

                // فحص البلوتوث
                if (bluetoothKeywords.some(k => label.includes(k))) {
                    badges += `<span class="badge badge-info"><i class="fa-brands fa-bluetooth-b ml-1"></i> بلوتوث لاسلكي</span>`;
                    isSuspicious = true;
                }
                // فحص USB
                else if (usbKeywords.some(k => label.includes(k))) {
                    badges += `<span class="badge badge-warn"><i class="fa-brands fa-usb ml-1"></i> سلكي (USB)</span>`;
                    isSuspicious = true;
                }

                // فحص عام خارجي
                if (isSuspicious || externalKeywords.some(k => label.includes(k))) {
                    badges += `<span class="badge badge-danger"><i class="fa-solid fa-plug ml-1"></i> جهاز خارجي</span>`;
                } else {
                    badges += `<span class="badge badge-safe"><i class="fa-solid fa-laptop ml-1"></i> داخلي / مدمج</span>`;
                }

                return badges;
            }

            // تحديث واجهة المايكروفون
            if (mic) {
                const micName = mic.label || "غير معروف (ربما تم حجب الاسم)";
                document.getElementById('mic-name').innerText = micName;
                document.getElementById('mic-badges').innerHTML = createBadges(micName);
                log(`تم تحليل المايك: ${micName}`, 'info');
            }

            // تحديث واجهة السماعات
            if (spk) {
                const spkName = spk.label || "غير معروف (أو مدمج بالنظام)";
                document.getElementById('spk-name').innerText = spkName;
                document.getElementById('spk-badges').innerHTML = createBadges(spkName);
                log(`تم تحليل السماعة: ${spkName}`, 'info');
            } else {
                document.getElementById('spk-name').innerText = "سماعات النظام الافتراضية";
                document.getElementById('spk-badges').innerHTML = `<span class="badge badge-safe">داخلي</span>`;
            }
        }

        // 3. رسم الموجات الصوتية
        function setupVisualizer() {
            canvas = document.getElementById('visualizer');
            canvasCtx = canvas.getContext('2d');
            
            // ضبط حجم الكانفاس
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            
            const source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);

            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawLoop();
        }

        function drawLoop() {
            requestAnimationFrame(drawLoop);
            analyser.getByteFrequencyData(dataArray);

            canvasCtx.fillStyle = '#000';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let x = 0;

            for(let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;
                
                // تدرج لوني أخضر
                const gradient = canvasCtx.createLinearGradient(0, canvas.height, 0, 0);
                gradient.addColorStop(0, '#064e3b'); // أخضر غامق
                gradient.addColorStop(1, '#22c55e'); // أخضر فاتح

                canvasCtx.fillStyle = gradient;
                canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 2;
            }
        }

        // 4. اختبار السماعة (إصدار صوت)
        function testSpeakerTone() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // إعداد التردد (صوت صفير ناعم)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.5);
            
            // خفض الصوت تدريجياً
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
            log('تم إرسال نغمة اختبار للسماعات.', 'warn');
        }

        // 5. اختبار المايك (تسجيل وإعادة)
        function testMicLoopback() {
            if (mediaRecorder && mediaRecorder.state === 'recording') return;

            log('بدء اختبار المايكروفون (Loopback)...', 'warn');
            
            const btn = document.getElementById('mic-test-btn');
            const btnText = document.getElementById('mic-btn-text');
            const subText = document.getElementById('mic-sub-text');
            const iconWrapper = document.getElementById('mic-icon-wrapper');

            chunks = [];
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                const audioURL = window.URL.createObjectURL(blob);
                const audio = new Audio(audioURL);
                
                btnText.innerText = "جاري تشغيل التسجيل...";
                subText.innerText = "استمع لصوتك الآن";
                btn.classList.add('border-green-500', 'text-green-400');
                
                audio.play();
                log('تم التسجيل. جاري إعادة التشغيل للتحقق.', 'success');

                audio.onended = () => {
                    // إعادة الزر لحالته
                    btnText.innerText = "اختبار الميكروفون";
                    subText.innerText = "تسجيل وإعادة الاستماع";
                    iconWrapper.innerHTML = '<i class="fa-solid fa-microphone text-2xl text-red-500 mb-2"></i>';
                    btn.classList.remove('border-green-500', 'text-green-400');
                    log('انتهى اختبار الميكروفون.', 'info');
                };
            };

            mediaRecorder.start();
            
            // تحديث الزر أثناء التسجيل
            btnText.innerText = "جاري التسجيل...";
            subText.innerText = "تحدث الآن...";
            iconWrapper.innerHTML = '<div class="recording-pulse"></div>';
            
            // إيقاف تلقائي بعد 3 ثواني
            setTimeout(() => {
                mediaRecorder.stop();
            }, 3000);
        }

        // ضبط الكانفاس عند تغيير حجم الشاشة
        window.addEventListener('resize', () => {
            if(canvas) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
        });

    </script>
</body>
</html>

