<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Ops Pro | Security & Analysis</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Tajawal:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                        tajawal: ['Tajawal', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: '#050505',
                        panel: '#111318',
                        primary: '#3b82f6', // Blue
                        security: '#ef4444', // Red for security
                        safe: '#10b981', // Green
                        warn: '#f59e0b', // Amber
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(239, 68, 68, 0.08) 0px, transparent 50%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(17, 19, 24, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .glass-panel:hover {
            border-color: rgba(59, 130, 246, 0.2);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.7);
        }

        .security-border {
            border-right: 3px solid #ef4444;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animations */
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Tab Navigation */
        .tab-btn {
            @apply px-4 py-2 text-sm font-bold text-slate-400 rounded-lg transition-all border border-transparent;
        }
        .tab-btn.active {
            @apply bg-blue-600/10 text-blue-400 border-blue-500/30 shadow-[0_0_15px_rgba(59,130,246,0.15)];
        }
        .hidden-tab { display: none; }
        
        /* Audio Player Styling */
        audio {
            width: 100%;
            height: 36px;
            filter: invert(0.92) hue-rotate(180deg);
            opacity: 0.8;
            border-radius: 8px;
        }
    </style>
</head>
<body class="font-cairo overflow-x-hidden">

    <!-- START SCREEN OVERLAY (Security & Permissions) -->
    <div id="start-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-md">
        <div class="text-center space-y-8 max-w-lg px-6 relative">
            <!-- Decorative Elements -->
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-600/20 rounded-full blur-[80px] -z-10"></div>
            
            <div class="w-24 h-24 mx-auto bg-slate-900 rounded-2xl flex items-center justify-center border border-slate-700 shadow-2xl relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-tr from-blue-600/20 to-transparent group-hover:opacity-100 transition-opacity"></div>
                <i class="fa-solid fa-fingerprint text-5xl text-blue-500"></i>
            </div>
            
            <div>
                <h1 class="text-4xl font-black text-white mb-2 tracking-tight">Sound<span class="text-blue-500">Ops</span> Pro</h1>
                <p class="text-slate-400 font-tajawal text-lg">منصة التحليل الصوتي والأمن السيبراني</p>
                <div class="mt-2 text-xs text-slate-600 font-mono">V4.6 | Mahmoud Ibrahim Ed.</div>
            </div>

            <div class="bg-slate-900/50 p-6 rounded-xl border border-white/5 text-right text-sm leading-relaxed text-slate-300">
                <h3 class="font-bold text-white mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved text-red-500"></i> بروتوكول الأمان والخصوصية
                </h3>
                <p class="mb-2">لضمان عمل أدوات <span class="text-blue-400">كشف العتاد (Hardware Fingerprinting)</span> وتحليل الطيف الصوتي، يتطلب النظام إذن الوصول للميكروفون.</p>
                <ul class="list-disc list-inside space-y-1 text-slate-400 text-xs">
                    <li>المعالجة تتم محلياً 100% داخل المتصفح.</li>
                    <li>لا يتم إرسال أي بيانات لخوادم خارجية.</li>
                </ul>
            </div>

            <button onclick="initializeSystem()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-900/30 transition-all flex items-center justify-center gap-3 group">
                <i class="fa-solid fa-power-off group-hover:rotate-90 transition-transform duration-500"></i> تشغيل النظام
            </button>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="main-app" class="container mx-auto px-4 py-6 max-w-7xl hidden opacity-0 transition-opacity duration-700">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-white/5 pb-6 gap-4">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-blue-600/20 border border-blue-500/30 flex items-center justify-center text-blue-400">
                    <i class="fa-solid fa-wave-square"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black text-white tracking-wide">Sound<span class="text-blue-500">Ops</span> Pro</h1>
                    <p class="text-[10px] text-slate-500 font-mono uppercase tracking-wider">Cyber Security & Audio Intelligence</p>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <nav class="flex p-1 bg-slate-900/50 rounded-lg border border-white/5">
                <button onclick="switchTab('tab-security')" id="btn-tab-security" class="tab-btn active">
                    <i class="fa-solid fa-shield-cat ml-1"></i> الأمن والعتاد
                </button>
                <button onclick="switchTab('tab-analysis')" id="btn-tab-analysis" class="tab-btn">
                    <i class="fa-solid fa-microchip ml-1"></i> المختبر الصوتي
                </button>
                <button onclick="switchTab('tab-ai')" id="btn-tab-ai" class="tab-btn">
                    <i class="fa-solid fa-robot ml-1"></i> الذكاء الاصطناعي
                </button>
            </nav>

            <div id="sys-status" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <span class="text-xs font-bold text-slate-300">النظام نشط</span>
            </div>
        </header>

        <!-- CONTENT AREA -->
        
        <!-- TAB 1: SECURITY & HARDWARE (الجانب الأمني) -->
        <div id="tab-security" class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
            
            <!-- Column 1: Hardware Monitor -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Live Visualizer -->
                <div class="glass-panel rounded-2xl p-1 relative overflow-hidden h-48 group">
                    <div class="absolute top-3 right-4 z-10 flex items-center gap-2 bg-black/40 px-2 py-1 rounded backdrop-blur-sm">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                        <span class="text-[10px] text-red-400 font-mono">LIVE SPECTRUM</span>
                    </div>
                    <canvas id="visualizer" class="w-full h-full rounded-xl opacity-80"></canvas>
                </div>

                <!-- Device Fingerprinting -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Mic Card -->
                    <div class="glass-panel rounded-xl p-5 security-border relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 text-slate-800/50 text-8xl -z-10 transform rotate-12">
                            <i class="fa-solid fa-microphone-lines"></i>
                        </div>
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-white/5 pb-2">وحدة الإدخال (Mic)</h3>
                        <div class="space-y-3 relative z-10">
                            <h2 id="mic-name" class="text-lg font-bold text-white leading-tight break-words font-tajawal">جاري الكشف...</h2>
                            <div id="mic-badges" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <!-- Speaker Card -->
                    <div class="glass-panel rounded-xl p-5 border-r-4 border-blue-500 relative overflow-hidden">
                         <div class="absolute -right-6 -top-6 text-slate-800/50 text-8xl -z-10 transform rotate-12">
                            <i class="fa-solid fa-headphones"></i>
                        </div>
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-white/5 pb-2">وحدة الإخراج (Speaker)</h3>
                        <div class="space-y-3 relative z-10">
                            <h2 id="spk-name" class="text-lg font-bold text-white leading-tight break-words font-tajawal">جاري الكشف...</h2>
                            <div id="spk-badges" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Hardware Tests -->
                <div class="grid grid-cols-2 gap-4">
                     <button onclick="testSpeakerTone()" class="glass-panel p-4 rounded-xl hover:bg-slate-800 transition-all text-center group">
                        <i class="fa-solid fa-volume-high text-2xl text-blue-500 mb-2 group-hover:scale-110 transition-transform"></i>
                        <div class="font-bold text-sm text-slate-200">اختبار السماعات</div>
                        <div class="text-[10px] text-slate-500">إصدار نغمة Sine Wave</div>
                    </button>
                    
                    <button id="mic-test-btn" onclick="testMicLoopback()" class="glass-panel p-4 rounded-xl hover:bg-slate-800 transition-all text-center group relative overflow-hidden">
                        <div class="relative z-10">
                            <div id="mic-icon-wrapper">
                                <i class="fa-solid fa-microphone text-2xl text-red-500 mb-2 group-hover:scale-110 transition-transform"></i>
                            </div>
                            <div id="mic-btn-text" class="font-bold text-sm text-slate-200">اختبار الميكروفون</div>
                            <div id="mic-sub-text" class="text-[10px] text-slate-500">تسجيل وإعادة فوري (Loopback)</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Column 2: System Logs -->
            <div class="lg:col-span-1">
                <div class="glass-panel rounded-2xl p-0 h-full flex flex-col overflow-hidden max-h-[500px]">
                    <div class="p-4 border-b border-white/5 bg-slate-900/50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-slate-300 font-mono"><i class="fa-solid fa-terminal text-green-500 ml-2"></i>System Logs</h3>
                        <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-500">Real-time</span>
                    </div>
                    <div id="logs" class="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-xs custom-scrollbar">
                        <!-- Logs will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: AUDIO LAB (تحليل الملفات) -->
        <div id="tab-analysis" class="hidden-tab grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">
            <!-- Upload Section -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel rounded-2xl p-6 text-center">
                    <div id="dropZone" class="border-2 border-dashed border-white/10 rounded-xl p-8 hover:border-blue-500/50 hover:bg-blue-500/5 transition-all cursor-pointer group">
                        <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-600 group-hover:text-blue-400 transition-colors mb-4"></i>
                        <h3 class="font-bold text-white mb-1">رفع ملف صوتي</h3>
                        <p class="text-xs text-slate-500 mb-4">WAV, MP3, OGG</p>
                        <input type="file" id="fileInput" accept="audio/*" class="hidden">
                        <button onclick="document.getElementById('fileInput').click()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs rounded-lg transition-colors">تصفح الملفات</button>
                    </div>
                    
                    <div class="relative flex py-5 items-center">
                        <div class="flex-grow border-t border-white/10"></div>
                        <span class="flex-shrink-0 mx-4 text-slate-600 text-[10px]">OR RECORD</span>
                        <div class="flex-grow border-t border-white/10"></div>
                    </div>

                    <div class="flex gap-2">
                        <button id="btnRecStart" class="flex-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-microphone"></i> تسجيل
                        </button>
                        <button id="btnRecStop" disabled class="flex-1 bg-slate-800 text-slate-500 py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                            <i class="fa-solid fa-stop"></i> إيقاف
                        </button>
                    </div>
                    <div id="recTimer" class="text-center mt-2 text-red-500 font-mono text-sm opacity-0">00:00</div>
                </div>
            </div>

            <!-- Analysis Result Section -->
            <div class="lg:col-span-8">
                <div class="glass-panel rounded-2xl p-6 min-h-[400px] relative">
                    <!-- Loader -->
                    <div id="loadingOverlay" class="absolute inset-0 bg-slate-900/90 z-20 hidden flex-col items-center justify-center rounded-2xl backdrop-blur-sm">
                        <div class="w-10 h-10 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-3"></div>
                        <div class="text-blue-400 text-sm font-bold animate-pulse">جاري معالجة البيانات...</div>
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-chart-line text-blue-500"></i> نتائج الفحص الطيفي
                        </h2>
                        <button id="btnAnalyze" disabled class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:bg-slate-800 text-white text-sm rounded-lg transition-all shadow-lg shadow-blue-900/20">
                            <i class="fa-solid fa-bolt ml-1"></i> تشغيل الفحص
                        </button>
                    </div>

                    <!-- Audio Player -->
                    <div class="mb-6 bg-slate-800/50 p-2 rounded-xl">
                        <audio id="audioPlayer" controls class="hidden"></audio>
                        <div id="empty-state-audio" class="text-center py-4 text-xs text-slate-600">
                            لا يوجد ملف صوتي محدد حالياً
                        </div>
                    </div>

                    <!-- Results Dashboard -->
                    <div id="resultsPanel" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                        <!-- Score Circle -->
                        <div class="bg-slate-900/50 rounded-xl p-4 flex flex-col items-center justify-center border border-white/5">
                            <div class="relative w-24 h-24 flex items-center justify-center mb-2">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="48" cy="48" r="40" stroke="#1e293b" stroke-width="8" fill="transparent" />
                                    <circle id="scoreCirclePath" cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="transparent" stroke-dasharray="251" stroke-dashoffset="251" class="text-blue-500 transition-all duration-1000" />
                                </svg>
                                <span id="scoreVal" class="absolute text-2xl font-black text-white">0</span>
                            </div>
                            <div id="verdictText" class="font-bold text-slate-300 mb-1">--</div>
                            <div class="text-[10px] text-slate-500">جودة الملف (Overall Quality)</div>
                        </div>

                        <!-- Technical Metrics -->
                        <div class="space-y-3">
                            <div class="bg-slate-900/50 rounded-lg p-3 flex justify-between items-center border border-white/5">
                                <span class="text-xs text-slate-400">Signal-to-Noise (SNR)</span>
                                <span id="valSNR" class="font-mono font-bold text-blue-400">-- dB</span>
                            </div>
                            <div class="bg-slate-900/50 rounded-lg p-3 flex justify-between items-center border border-white/5">
                                <span class="text-xs text-slate-400">Voice Activity (VAD)</span>
                                <span id="valVAD" class="font-mono font-bold text-emerald-400">-- %</span>
                            </div>
                            <div class="bg-slate-900/50 rounded-lg p-3 border border-white/5">
                                <h4 class="text-[10px] font-bold text-slate-500 mb-1">التوصيات التقنية:</h4>
                                <ul id="recommendations" class="text-[11px] text-slate-300 list-disc list-inside space-y-1"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: AI (الذكاء الاصطناعي) -->
        <div id="tab-ai" class="hidden-tab grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
            
            <!-- STT -->
            <div class="glass-panel rounded-2xl p-6 relative group overflow-hidden">
                <div class="absolute top-0 right-0 w-1 h-full bg-gradient-to-b from-red-500 to-transparent opacity-50"></div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-microphone-lines text-red-500"></i> تحويل الكلام لنص
                    </h2>
                    <span id="stt-status" class="text-[10px] px-2 py-1 rounded bg-slate-800 text-slate-400 border border-slate-700">Ready</span>
                </div>

                <!-- Text Area for STT -->
                <textarea id="speech-result" rows="8" class="w-full bg-black/40 text-slate-100 p-4 rounded-xl border border-white/10 focus:border-red-500/50 outline-none resize-none text-sm leading-relaxed placeholder-slate-700 mb-4 transition-colors" placeholder="اضغط زر الميكروفون وتحدث..."></textarea>
                
                <div class="flex items-center justify-between">
                    <button id="record-btn" onclick="toggleSTT()" class="w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-red-500 border border-red-500/20 shadow-lg flex items-center justify-center transition-all">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <div class="flex gap-2">
                        <button onclick="copyText('speech-result')" class="p-2 text-slate-500 hover:text-white transition"><i class="fa-regular fa-copy"></i></button>
                        <button onclick="document.getElementById('speech-result').value=''" class="p-2 text-slate-500 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>

            <!-- TTS -->
            <div class="glass-panel rounded-2xl p-6 relative group overflow-hidden">
                <div class="absolute top-0 right-0 w-1 h-full bg-gradient-to-b from-blue-500 to-transparent opacity-50"></div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-volume-high text-blue-500"></i> ناطق النصوص
                    </h2>
                    <div class="text-[10px] text-slate-400 bg-slate-800 px-2 py-1 rounded">Arabic / Auto</div>
                </div>

                <textarea id="tts-input" rows="8" class="w-full bg-black/40 text-slate-100 p-4 rounded-xl border border-white/10 focus:border-blue-500/50 outline-none resize-none text-sm leading-relaxed placeholder-slate-700 mb-4 transition-colors" placeholder="اكتب النص هنا ليتم قراءته..."></textarea>
                
                <div class="flex gap-3">
                    <button onclick="speakText()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold rounded-lg shadow-lg shadow-blue-900/20 transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-play"></i> قراءة
                    </button>
                    <button onclick="window.speechSynthesis.cancel()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg border border-white/10 transition-all">
                        <i class="fa-solid fa-stop"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 border-t border-white/5 pt-6 text-center">
            <p class="text-[11px] text-slate-600 font-tajawal">
                Developed by <span class="text-blue-500 font-bold">Mahmoud Ibrahim</span> | Department of History & Cyber Security Enthusiast<br>
                Sound Ops Pro System - Private Edition
            </p>
        </footer>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // Global Variables
        let audioCtx, analyser, dataArray, canvas, canvasCtx, stream;
        let mediaRecorder, chunks = [];
        let currentFileBuffer = null;
        let isSystemInit = false;

        // --- SYSTEM INITIALIZATION ---
        async function initializeSystem() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Request Mic Permission for Hardware Fingerprinting & Visualizer
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // UI Transitions
                const startScreen = document.getElementById('start-screen');
                const mainApp = document.getElementById('main-app');
                
                startScreen.style.opacity = '0';
                setTimeout(() => {
                    startScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    setTimeout(() => mainApp.style.opacity = '1', 50);
                }, 700);

                isSystemInit = true;
                log('System initialized successfully.', 'success');
                log('Hardware access granted.', 'success');

                // Start Core Functions
                setupVisualizer();
                detectHardware();
                
                // Monitor Device Changes
                navigator.mediaDevices.ondevicechange = () => {
                    log('Hardware change detected!', 'alert');
                    detectHardware();
                };

            } catch (err) {
                console.error(err);
                alert("يجب السماح باستخدام الميكروفون ليعمل النظام.");
                log('Permission denied: Microphone access required.', 'alert');
            }
        }

        // --- TAB MANAGEMENT ---
        function switchTab(tabId) {
            // Hide all tabs
            ['tab-security', 'tab-analysis', 'tab-ai'].forEach(id => {
                document.getElementById(id).classList.add('hidden-tab');
                document.getElementById('btn-' + id).classList.remove('active');
            });
            // Show selected
            document.getElementById(tabId).classList.remove('hidden-tab');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        // --- LOGGING SYSTEM ---
        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const el = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            
            let colorClass = 'text-slate-400 border-l-2 border-slate-600';
            if(type === 'alert') colorClass = 'text-red-400 border-l-2 border-red-500 bg-red-500/5';
            if(type === 'success') colorClass = 'text-emerald-400 border-l-2 border-emerald-500';
            if(type === 'warn') colorClass = 'text-amber-400 border-l-2 border-amber-500';

            el.className = `pl-2 py-1 ${colorClass} text-[10px] break-words animate-fade-in`;
            el.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span> ${msg}`;
            logs.prepend(el);
        }

        // --- SECURITY: HARDWARE DETECTION ---
        async function detectHardware() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            
            // Keywords for suspicious/external devices
            const bluetoothKeywords = ['bluetooth', 'wireless', 'airpods', 'buds', 'freebuds', 'jbl', 'sony', 'bose'];
            const usbKeywords = ['usb', 'dongle'];
            const externalKeywords = ['headset', 'headphone', 'external', 'mic', 'سماعة'];

            const mic = devices.find(d => d.kind === 'audioinput' && d.deviceId !== 'default') || devices.find(d => d.kind === 'audioinput');
            const spk = devices.find(d => d.kind === 'audiooutput' && d.deviceId !== 'default') || devices.find(d => d.kind === 'audiooutput');

            function createBadges(label) {
                label = label.toLowerCase();
                let badges = '';
                let isExt = false;

                if (bluetoothKeywords.some(k => label.includes(k))) {
                    badges += `<span class="px-2 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20 text-[10px] flex items-center gap-1"><i class="fa-brands fa-bluetooth-b"></i> Bluetooth</span>`;
                    isExt = true;
                } else if (usbKeywords.some(k => label.includes(k))) {
                    badges += `<span class="px-2 py-0.5 rounded bg-amber-500/10 text-amber-400 border border-amber-500/20 text-[10px] flex items-center gap-1"><i class="fa-brands fa-usb"></i> USB</span>`;
                    isExt = true;
                }

                if (isExt || externalKeywords.some(k => label.includes(k))) {
                    badges += `<span class="px-2 py-0.5 rounded bg-red-500/10 text-red-400 border border-red-500/20 text-[10px] flex items-center gap-1"><i class="fa-solid fa-plug"></i> External</span>`;
                } else {
                    badges += `<span class="px-2 py-0.5 rounded bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 text-[10px] flex items-center gap-1"><i class="fa-solid fa-laptop"></i> Built-in</span>`;
                }
                return badges;
            }

            if (mic) {
                const name = mic.label || "Hidden ID (Privacy Mode)";
                document.getElementById('mic-name').innerText = name;
                document.getElementById('mic-badges').innerHTML = createBadges(name);
                log(`Audio Input Detected: ${name}`);
            }

            if (spk) {
                const name = spk.label || "System Default";
                document.getElementById('spk-name').innerText = name;
                document.getElementById('spk-badges').innerHTML = createBadges(name);
                log(`Audio Output Detected: ${name}`);
            } else {
                document.getElementById('spk-name').innerText = "System Default / Restricted";
                document.getElementById('spk-badges').innerHTML = `<span class="px-2 py-0.5 rounded bg-slate-700 text-slate-400 text-[10px]">System</span>`;
            }
        }

        // --- SECURITY: VISUALIZER ---
        function setupVisualizer() {
            canvas = document.getElementById('visualizer');
            canvasCtx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            
            const source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);

            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawLoop();
        }

        function drawLoop() {
            requestAnimationFrame(drawLoop);
            analyser.getByteFrequencyData(dataArray);

            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let x = 0;

            for(let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;
                
                // Dynamic Color based on height (Green safe, Red loud)
                let r = barHeight + (25 * (i/dataArray.length));
                let g = 250 * (i/dataArray.length);
                let b = 50;
                
                if (barHeight > canvas.height * 0.8) { // Clipping warning color
                    canvasCtx.fillStyle = `rgb(239, 68, 68)`; 
                } else {
                    canvasCtx.fillStyle = `rgba(59, 130, 246, 0.8)`; // Blue default
                }

                canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 2;
            }
        }

        // --- SECURITY: TESTS ---
        function testSpeakerTone() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
            log('Speaker test tone emitted (Sine 440Hz).', 'warn');
        }

        function testMicLoopback() {
            if (mediaRecorder && mediaRecorder.state === 'recording') return;
            log('Starting Loopback test...', 'warn');
            
            const btn = document.getElementById('mic-test-btn');
            const btnText = document.getElementById('mic-btn-text');
            const subText = document.getElementById('mic-sub-text');
            const iconWrapper = document.getElementById('mic-icon-wrapper');

            chunks = [];
            const recorder = new MediaRecorder(stream);
            
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                const audioURL = window.URL.createObjectURL(blob);
                const audio = new Audio(audioURL);
                
                btnText.innerText = "تشغيل التسجيل...";
                subText.innerText = "جاري التحقق من الصوت";
                btn.classList.add('border', 'border-green-500/50', 'bg-green-500/10');
                
                audio.play();
                log('Loopback recording finished. Playing back.', 'success');

                audio.onended = () => {
                    btnText.innerText = "اختبار الميكروفون";
                    subText.innerText = "تسجيل وإعادة فوري (Loopback)";
                    iconWrapper.innerHTML = '<i class="fa-solid fa-microphone text-2xl text-red-500 mb-2"></i>';
                    btn.classList.remove('border', 'border-green-500/50', 'bg-green-500/10');
                    log('Loopback test completed.', 'info');
                };
            };

            recorder.start();
            btnText.innerText = "جاري التسجيل...";
            subText.innerText = "تحدث الآن...";
            iconWrapper.innerHTML = '<div class="recording-pulse w-6 h-6 bg-red-500 rounded-full mx-auto mb-2"></div>';
            
            setTimeout(() => { recorder.stop(); }, 3000);
        }

        // --- ANALYSIS: FILE HANDLING ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const btnAnalyze = document.getElementById('btnAnalyze');
        const player = document.getElementById('audioPlayer');
        const emptyState = document.getElementById('empty-state-audio');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-500/10'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500', 'bg-blue-500/10'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-500/10');
            if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if(e.target.files[0]) handleFile(e.target.files[0]); });

        async function handleFile(file) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                currentFileBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                const url = URL.createObjectURL(file);
                
                player.src = url;
                player.classList.remove('hidden');
                emptyState.classList.add('hidden');
                
                btnAnalyze.disabled = false;
                btnAnalyze.innerHTML = `<i class="fa-solid fa-bolt ml-1"></i> فحص (${(currentFileBuffer.duration).toFixed(1)}s)`;
                
                // Hide results until re-analyzed
                document.getElementById('resultsPanel').classList.add('hidden');
                
                log(`File loaded: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`, 'info');
            } catch (err) {
                alert("خطأ في قراءة الملف.");
                console.error(err);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        btnAnalyze.addEventListener('click', () => {
            if(!currentFileBuffer) return;
            const results = performAnalysis(currentFileBuffer);
            displayResults(results);
        });

        function performAnalysis(buffer) {
            const rawData = buffer.getChannelData(0);
            // Root Mean Square (RMS) Calculation
            let sum = 0;
            // Sampling to save performance
            const step = Math.ceil(rawData.length / 50000); 
            for(let i=0; i<rawData.length; i+=step) {
                sum += rawData[i] * rawData[i];
            }
            const rms = Math.sqrt(sum / (rawData.length/step));
            const db = 20 * Math.log10(rms);
            
            // Logic for Score
            let score = 50;
            if (buffer.duration > 2) score += 10;
            if (db > -40 && db < -10) score += 30; // Good volume range
            else if (db > -5) score -= 10; // Too loud (clipping)
            
            const snr = Math.abs(db) + 10;
            const vad = Math.min(0.99, Math.max(0.1, rms * 6));
            
            return { score: Math.min(98, Math.round(score)), snr: snr.toFixed(1), vad: vad };
        }

        function displayResults(data) {
            document.getElementById('resultsPanel').classList.remove('hidden');
            document.getElementById('scoreVal').innerText = data.score;
            
            // Circle Animation
            const circle = document.getElementById('scoreCirclePath');
            const offset = 251 - (251 * data.score) / 100;
            circle.style.strokeDashoffset = offset;
            
            // Verdict Colors
            let color = 'text-red-500';
            let verdict = 'Poor Quality';
            circle.classList.remove('text-red-500', 'text-blue-500', 'text-emerald-500');
            
            if(data.score > 75) { 
                color = 'text-emerald-500'; 
                verdict = 'Excellent (Studio)'; 
                circle.classList.add('text-emerald-500');
            } else if(data.score > 50) { 
                color = 'text-blue-500'; 
                verdict = 'Good (Acceptable)'; 
                circle.classList.add('text-blue-500');
            } else {
                circle.classList.add('text-red-500');
            }

            document.getElementById('verdictText').innerText = verdict;
            document.getElementById('verdictText').className = `font-bold mb-1 ${color}`;
            document.getElementById('valSNR').innerText = data.snr + ' dB';
            document.getElementById('valVAD').innerText = (data.vad * 100).toFixed(0) + ' %';
            
            // Recommendations
            const rec = document.getElementById('recommendations');
            rec.innerHTML = '';
            if(data.score < 60) rec.innerHTML += `<li class="text-red-300">High noise floor detected. Use Noise Reduction.</li>`;
            if(data.vad < 0.3) rec.innerHTML += `<li class="text-amber-300">Low signal. Amplify audio gain.</li>`;
            if(data.score >= 80) rec.innerHTML += `<li class="text-emerald-300">File is clean and ready for publishing.</li>`;
            
            log(`Analysis Complete. Score: ${data.score}/100`, 'success');
        }

        // --- ANALYSIS: RECORDING ---
        let recInterval;
        let recStartTime;
        document.getElementById('btnRecStart').addEventListener('click', async () => {
             const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
             mediaRecorder = new MediaRecorder(stream);
             chunks = [];
             mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
             mediaRecorder.onstop = () => {
                 const blob = new Blob(chunks, { type: 'audio/webm' });
                 const file = new File([blob], "mic_recording.webm", { type: 'audio/webm' });
                 handleFile(file);
                 stream.getTracks().forEach(track => track.stop());
                 clearInterval(recInterval);
                 document.getElementById('recTimer').style.opacity = '0';
             };
             mediaRecorder.start();
             
             document.getElementById('btnRecStart').disabled = true;
             document.getElementById('btnRecStop').disabled = false;
             document.getElementById('btnRecStart').innerHTML = `<i class="fa-solid fa-circle animate-pulse text-red-500"></i> Recording...`;
             
             recStartTime = Date.now();
             document.getElementById('recTimer').style.opacity = '1';
             recInterval = setInterval(() => {
                 const diff = Math.floor((Date.now() - recStartTime) / 1000);
                 const m = Math.floor(diff / 60).toString().padStart(2,'0');
                 const s = (diff % 60).toString().padStart(2,'0');
                 document.getElementById('recTimer').innerText = `${m}:${s}`;
             }, 1000);
        });

        document.getElementById('btnRecStop').addEventListener('click', () => {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            document.getElementById('btnRecStart').disabled = false;
            document.getElementById('btnRecStop').disabled = true;
            document.getElementById('btnRecStart').innerHTML = `<i class="fa-solid fa-microphone"></i> تسجيل`;
        });

        // --- AI: STT (Logic Borrowed from 'learn_the_sound.html') ---
        let recognition;
        let isSTTRec = false;

        function initSTT() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ar-EG';
                
                // === THE KEY FIX ===
                // Setting interimResults to false means we ONLY get the final, processed string.
                // Setting continuous to false means we restart manually, preventing buffer duplication.
                recognition.interimResults = false;
                recognition.continuous = false; 

                recognition.onstart = () => {
                    isSTTRec = true;
                    document.getElementById('stt-status').innerText = "Listening...";
                    document.getElementById('stt-status').classList.add('bg-red-500/20', 'text-red-400');
                    document.getElementById('record-btn').classList.add('bg-red-600', 'text-white');
                };

                recognition.onend = () => {
                    if (isSTTRec) {
                        recognition.start(); // Auto-restart loop
                    } else {
                        document.getElementById('stt-status').innerText = "Ready";
                        document.getElementById('stt-status').classList.remove('bg-red-500/20', 'text-red-400');
                        document.getElementById('record-btn').classList.remove('bg-red-600', 'text-white');
                    }
                };

                recognition.onerror = (event) => {
                    if (event.error !== 'no-speech' && event.error !== 'audio-capture') {
                        isSTTRec = false; // Stop on real errors
                    }
                };

                recognition.onresult = (event) => {
                    // Since continuous=false, the result is always at index 0
                    const transcript = event.results[0][0].transcript;
                    const textarea = document.getElementById('speech-result');
                    
                    // Simple append logic
                    textarea.value = (textarea.value + ' ' + transcript).trim();
                    textarea.scrollTop = textarea.scrollHeight;
                };

                recognition.start();

            } else {
                alert("Browser not supported for STT");
            }
        }

        function toggleSTT() {
            if (!recognition) {
                initSTT();
            } else {
                if (isSTTRec) {
                    isSTTRec = false;
                    recognition.stop();
                } else {
                    recognition.start();
                }
            }
        }

        // --- AI: TTS ---
        function speakText() {
            const text = document.getElementById('tts-input').value;
            if(!text) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-EG';
            window.speechSynthesis.speak(u);
            log('TTS started.', 'info');
        }

        function copyText(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            log('Text copied to clipboard.', 'success');
        }

        // Resize Canvas on Window Resize
        window.addEventListener('resize', () => {
            if(canvas) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
        });

    </script>
</body>
</html>

